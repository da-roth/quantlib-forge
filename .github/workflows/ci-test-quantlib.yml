##############################################################################
#
#  QuantLib-Forge CI Test + QuantLib Tests Workflow
#
#  Full build with all tests on Linux and Windows.
#  Applies all Forge-aware patches and runs both forge-test-suite AND
#  the full QuantLib test suite.
#
#  This file is part of QuantLib-Forge, a Forge integration layer for QuantLib.
#
#  Copyright (C) 2025 The QuantLib-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: CI Test + QuantLib Tests

run-name: "CI Test + QuantLib: ${{ github.event.head_commit.message || github.ref_name }}"

on:
  workflow_dispatch:  # Manual trigger only (long running)

env:
  BOOST_VERSION: 1_84_0
  BOOST_VERSION_DOT: 1.84.0

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            container: ghcr.io/lballabio/quantlib-devenv:rolling
          - os: windows-latest
            container: null

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - name: Checkout quantlib-forge
        uses: actions/checkout@v4
        with:
          path: quantlib-forge

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: lballabio/QuantLib
          path: quantlib
          fetch-depth: 0

      - name: Pin QuantLib to pre-multicurve commit
        run: |
          cd quantlib
          git checkout b3612ef
        shell: bash

      # Linux-specific setup
      - name: Setup (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          apt-get update && apt-get install -y ninja-build

      # Windows-specific Boost setup
      - name: Cache Boost (Windows)
        if: matrix.os == 'windows-latest'
        id: cache-boost
        uses: actions/cache@v4
        with:
          path: C:/local/boost_${{ env.BOOST_VERSION }}
          key: boost-${{ env.BOOST_VERSION }}-msvc-x64

      - name: Install Boost (Windows)
        if: matrix.os == 'windows-latest' && steps.cache-boost.outputs.cache-hit != 'true'
        run: |
          $boostUrl = "https://archives.boost.io/release/${{ env.BOOST_VERSION_DOT }}/source/boost_${{ env.BOOST_VERSION }}.zip"
          $boostZip = "C:/temp/boost.zip"
          $boostExtract = "C:/temp/boost"

          New-Item -ItemType Directory -Force -Path C:/temp
          New-Item -ItemType Directory -Force -Path C:/local

          Write-Host "Downloading Boost..."
          Invoke-WebRequest -Uri $boostUrl -OutFile $boostZip

          Write-Host "Extracting Boost..."
          Expand-Archive -Path $boostZip -DestinationPath $boostExtract

          Move-Item -Path "$boostExtract/boost_${{ env.BOOST_VERSION }}" -Destination "C:/local/boost_${{ env.BOOST_VERSION }}"

          Write-Host "Building Boost..."
          cd "C:/local/boost_${{ env.BOOST_VERSION }}"
          ./bootstrap.bat
          ./b2 --with-test --with-system --with-filesystem --with-serialization --with-regex --with-date_time link=static runtime-link=static variant=release address-model=64 threading=multi
        shell: pwsh

      # Build Forge - Linux
      - name: Build Forge (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd forge
          cmake -B build -S tools/packaging \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install-release"
          cmake --build build --config Release
          cmake --install build --config Release

      # Build Forge - Windows
      - name: Build Forge (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd forge
          cmake -B build -S tools/packaging `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install-release"
          cmake --build build --config Release
          cmake --install build --config Release
        shell: pwsh

      # Apply all QuantLib patches - Linux
      - name: Apply QuantLib patches (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd quantlib
          echo "Applying QuantLib ABool patch..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-abool.patch
          echo "Applying Forge-aware ErrorFunction patches..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-errorfunction.hpp.patch
          git apply ../quantlib-forge/patches/quantlib/quantlib-errorfunction.cpp.patch
          echo "Applying Forge-aware NormalDistribution patches..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-normaldistribution.hpp.patch
          git apply ../quantlib-forge/patches/quantlib/quantlib-normaldistribution.cpp.patch
          echo "Applying Forge-aware AnalyticBarrierEngine patch..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-analyticbarrierengine.cpp.patch
          echo "All QuantLib patches applied."

      # Apply all QuantLib patches - Windows
      - name: Apply QuantLib patches (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd quantlib
          Write-Host "Applying QuantLib ABool patch..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-abool.patch
          Write-Host "Applying Forge-aware ErrorFunction patches..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-errorfunction.hpp.patch
          git apply ../quantlib-forge/patches/quantlib/quantlib-errorfunction.cpp.patch
          Write-Host "Applying Forge-aware NormalDistribution patches..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-normaldistribution.hpp.patch
          git apply ../quantlib-forge/patches/quantlib/quantlib-normaldistribution.cpp.patch
          Write-Host "Applying Forge-aware AnalyticBarrierEngine patch..."
          git apply ../quantlib-forge/patches/quantlib/quantlib-analyticbarrierengine.cpp.patch
          Write-Host "All QuantLib patches applied."
        shell: pwsh

      # Build QuantLib with ALL tests - Linux
      - name: Build QuantLib with QuantLib-Forge (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd quantlib
          cmake -B build -S . \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/install-release" \
            -DCMAKE_CXX_FLAGS="-Wno-reorder" \
            -DQL_BUILD_TEST_SUITE=ON \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQL_ENABLE_SESSIONS=ON \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_FORGE_DISABLE_AAD=OFF \
            -DQL_FORGE_BUILD_TEST_SUITE=ON \
            -DQL_EXTERNAL_SUBDIRECTORIES="../quantlib-forge" \
            -DQL_EXTRA_LINK_LIBRARIES="QuantLib-Forge"
          cmake --build build --config Release

      # Build QuantLib with ALL tests - Windows
      - name: Build QuantLib with QuantLib-Forge (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd quantlib
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/install-release" `
            -DBOOST_ROOT="C:/local/boost_${{ env.BOOST_VERSION }}" `
            -DBoost_USE_STATIC_LIBS=ON `
            -DBoost_USE_STATIC_RUNTIME=ON `
            -DQL_BUILD_TEST_SUITE=ON `
            -DQL_BUILD_EXAMPLES=OFF `
            -DQL_BUILD_BENCHMARK=OFF `
            -DQL_ENABLE_SESSIONS=ON `
            -DQL_NULL_AS_FUNCTIONS=ON `
            -DQL_FORGE_DISABLE_AAD=OFF `
            -DQL_FORGE_BUILD_TEST_SUITE=ON `
            -DQL_EXTERNAL_SUBDIRECTORIES="../quantlib-forge" `
            -DQL_EXTRA_LINK_LIBRARIES="QuantLib-Forge"
          cmake --build build --config Release
        shell: pwsh

      # Run Forge tests - Linux
      - name: Run Forge Test Suite (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd quantlib/build
          TEST_EXE=$(find . -name "forge-test-suite" -type f -executable | head -1)

          echo "============================================================="
          echo "  Running QuantLib-Forge Tests on Linux"
          echo "============================================================="

          if [ -n "$TEST_EXE" ]; then
            $TEST_EXE --log_level=message
          else
            echo "Forge test executable not found!"
            exit 1
          fi

          echo ""
          echo "============================================================="
          echo "  Forge Tests Passed on Linux"
          echo "============================================================="

      # Run Forge tests - Windows
      - name: Run Forge Test Suite (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd quantlib/build
          $testExe = Get-ChildItem -Recurse -Filter "forge-test-suite.exe" | Select-Object -First 1

          Write-Host "============================================================="
          Write-Host "  Running QuantLib-Forge Tests on Windows"
          Write-Host "============================================================="

          if ($testExe) {
            Write-Host "Running tests from: $($testExe.FullName)"
            & $testExe.FullName --log_level=message
          } else {
            Write-Host "Forge test executable not found!"
            exit 1
          }

          Write-Host ""
          Write-Host "============================================================="
          Write-Host "  Forge Tests Passed on Windows"
          Write-Host "============================================================="
        shell: pwsh

      # Run QuantLib tests - Linux
      - name: Run QuantLib Test Suite (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd quantlib/build
          TEST_EXE=$(find . -name "quantlib-test-suite" -type f -executable | head -1)

          echo "============================================================="
          echo "  Running QuantLib Tests on Linux"
          echo "============================================================="

          if [ -n "$TEST_EXE" ]; then
            $TEST_EXE --log_level=message
          else
            echo "QuantLib test executable not found!"
            exit 1
          fi

          echo ""
          echo "============================================================="
          echo "  QuantLib Tests Passed on Linux"
          echo "============================================================="

      # Run QuantLib tests - Windows
      - name: Run QuantLib Test Suite (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd quantlib/build
          $testExe = Get-ChildItem -Recurse -Filter "quantlib-test-suite.exe" | Select-Object -First 1

          Write-Host "============================================================="
          Write-Host "  Running QuantLib Tests on Windows"
          Write-Host "============================================================="

          if ($testExe) {
            Write-Host "Running tests from: $($testExe.FullName)"
            & $testExe.FullName --log_level=message
          } else {
            Write-Host "QuantLib test executable not found!"
            exit 1
          }

          Write-Host ""
          Write-Host "============================================================="
          Write-Host "  QuantLib Tests Passed on Windows"
          Write-Host "============================================================="
        shell: pwsh
