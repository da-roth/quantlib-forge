##############################################################################
#
#  QuantLib-Forge Benchmark Workflow - Baseline
#
#  Builds plain QuantLib (no AAD) and runs the XVA benchmark with finite
#  differences. This provides a baseline for comparing AAD approaches.
#
#  This file is part of QuantLib-Forge, a Forge integration layer for QuantLib.
#
#  Copyright (C) 2025 The QuantLib-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: Benchmark Baseline

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  benchmark-baseline:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    steps:
      - name: Checkout quantlib-forge (for benchmark files)
        uses: actions/checkout@v4

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: lballabio/QuantLib
          path: QuantLib
          fetch-depth: 0

      - name: Pin QuantLib to pre-multicurve commit
        run: |
          cd QuantLib
          git checkout b3612ef

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build

      - name: Configure QuantLib (plain, no AAD)
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            ..

      - name: Compile QuantLib
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Install QuantLib
        run: |
          cd QuantLib/build
          cmake --install . --prefix ${{ github.workspace }}/install

      - name: Build Baseline Benchmark
        run: |
          mkdir benchmark-build
          cd benchmark-build
          cat > CMakeLists.txt << 'EOF'
          cmake_minimum_required(VERSION 3.15)
          project(SwapXvaBaseline LANGUAGES CXX)
          find_package(QuantLib REQUIRED)
          add_executable(swap_xva_baseline $ENV{GITHUB_WORKSPACE}/benchmarks/swap_xva_baseline.cpp)
          target_link_libraries(swap_xva_baseline PRIVATE QuantLib::QuantLib)
          target_compile_features(swap_xva_baseline PUBLIC cxx_std_17)
          EOF
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install \
            .
          cmake --build .

      - name: Run Baseline Benchmark
        run: |
          cd benchmark-build
          echo "============================================================="
          echo "  Baseline Benchmark - Plain QuantLib (Finite Differences)"
          echo "============================================================="
          ./swap_xva_baseline
