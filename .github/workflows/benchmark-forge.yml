##############################################################################
#
#  QuantLib-Forge Benchmark Workflow
#
#  Builds QuantLib with Forge and runs the comprehensive XVA benchmark
#  that compares ALL approaches: Bump-Reval, Forward-Only, and AAD,
#  with SSE2 vs AVX2 and different optimization levels.
#
#  This file is part of QuantLib-Forge, a Forge integration layer for QuantLib.
#
#  Copyright (C) 2025 The QuantLib-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: Benchmark Forge

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  benchmark-forge:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    steps:
      - name: Checkout quantlib-forge
        uses: actions/checkout@v4
        with:
          path: quantlib-forge

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: lballabio/QuantLib
          path: QuantLib
          fetch-depth: 0

      - name: Pin QuantLib to pre-multicurve commit
        run: |
          cd QuantLib
          git checkout b3612ef

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build

      - name: Check CPU capabilities
        run: |
          echo "============================================================="
          echo "  CPU Capabilities"
          echo "============================================================="
          cat /proc/cpuinfo | grep -m1 "model name" || true
          echo ""
          echo "AVX2 support:"
          grep -q avx2 /proc/cpuinfo && echo "  AVX2: SUPPORTED" || echo "  AVX2: NOT SUPPORTED"
          grep -q avx /proc/cpuinfo && echo "  AVX:  SUPPORTED" || echo "  AVX:  NOT SUPPORTED"
          grep -q sse2 /proc/cpuinfo && echo "  SSE2: SUPPORTED" || echo "  SSE2: NOT SUPPORTED"

      - name: Build Forge
        run: |
          cd forge
          cmake -B build -S tools/packaging \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install
          cmake --build build --config Release
          cmake --install build --config Release

      - name: Configure QuantLib with QuantLib-Forge
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install \
            -DCMAKE_CXX_FLAGS="-Wno-reorder" \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQL_ENABLE_SESSIONS=ON \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_FORGE_DISABLE_AAD=OFF \
            -DQL_FORGE_BUILD_TEST_SUITE=OFF \
            -DQL_FORGE_BUILD_TEST_SUITE=OFF \
            -DQL_EXTERNAL_SUBDIRECTORIES="../quantlib-forge" \
            -DQL_EXTRA_LINK_LIBRARIES="QuantLib-Forge" \
            ..

      - name: Compile QuantLib
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Install QuantLib
        run: |
          cd QuantLib/build
          cmake --install . --prefix ${{ github.workspace }}/install

      - name: Build Comprehensive Forge Benchmark
        run: |
          mkdir benchmark-build
          cd benchmark-build
          cat > CMakeLists.txt << 'EOF'
          cmake_minimum_required(VERSION 3.15)
          project(SwapXvaForgeAll LANGUAGES CXX)
          find_package(QuantLib REQUIRED)
          find_package(Forge CONFIG REQUIRED)
          add_executable(swap_xva_forge_all $ENV{GITHUB_WORKSPACE}/quantlib-forge/benchmarks/swap_xva_forge_all.cpp)
          target_link_libraries(swap_xva_forge_all PRIVATE QuantLib::QuantLib Forge::forge)
          target_compile_features(swap_xva_forge_all PUBLIC cxx_std_17)
          target_compile_options(swap_xva_forge_all PRIVATE -mavx2)
          EOF
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install \
            .
          cmake --build .

      - name: Run Forge Benchmark
        run: |
          cd benchmark-build
          echo "============================================================="
          echo "  Forge Benchmark - All Approaches"
          echo "============================================================="
          ./swap_xva_forge_all

